<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이미지 리사이즈 & WebP 변환기</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .instructions {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions h2 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #6c757d;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .highlight {
            color: #007bff;
            font-weight: 500;
        }

        .drop-zone {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .drop-zone:hover {
            background: #e7f3ff;
            border-color: #0056b3;
        }

        .drop-zone.drag-over {
            background: #e7f3ff;
            border-color: #0056b3;
            transform: scale(1.02);
        }

        .drop-zone svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            fill: #007bff;
        }

        .drop-zone p {
            font-size: 18px;
            color: #495057;
            margin-bottom: 10px;
        }

        .drop-zone span {
            font-size: 14px;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .settings {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .quality-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .quality-value {
            text-align: center;
            color: #007bff;
            font-weight: 500;
        }

        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .file-item {
            padding: 8px;
            border-bottom: 1px solid #f1f3f5;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #e9ecef;
        }

        .file-item .status.processing {
            background: #fff3cd;
            color: #856404;
        }

        .file-item .status.completed {
            background: #d4edda;
            color: #155724;
        }

        .file-item .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .button {
            padding: 12px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 20px;
        }

        .button:hover {
            background: #0056b3;
        }

        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            font-size: 14px;
            color: #004085;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>이미지 리사이즈 & WebP 변환기</h1>
        
        <div class="instructions">
            <h2>📖 사용방법</h2>
            <ol>
                <li>아래 영역에 <span class="highlight">이미지 폴더</span>를 드래그 앤 드롭하세요</li>
                <li>또는 클릭해서 이미지 파일들을 선택하세요</li>
                <li><span class="highlight">1920px보다 큰 이미지</span>는 자동으로 리사이즈됩니다</li>
                <li>모든 이미지는 <span class="highlight">WebP 형식</span>으로 변환됩니다</li>
                <li>변환이 완료되면 <span class="highlight">ZIP 파일</span>로 다운로드됩니다</li>
            </ol>
        </div>

        <div class="drop-zone" id="dropZone">
            <svg viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
            <p>이미지 폴더를 여기에 드롭하세요</p>
            <span>또는 클릭해서 파일 선택</span>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/*" webkitdirectory directory>
        </div>

        <div class="settings" id="settings">
            <div class="setting-group">
                <label for="quality">WebP 품질 설정</label>
                <input type="range" id="quality" class="quality-slider" min="50" max="100" value="85">
                <div class="quality-value" id="qualityValue">85%</div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="file-list" id="fileList"></div>
            <button class="button" id="downloadButton" style="display: none;">ZIP 파일 다운로드</button>
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const settings = document.getElementById('settings');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const fileList = document.getElementById('fileList');
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const downloadButton = document.getElementById('downloadButton');
        const stats = document.getElementById('stats');

        let processedFiles = [];
        let totalSize = 0;
        let convertedSize = 0;

        // 품질 슬라이더 이벤트
        qualitySlider.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value + '%';
        });

        // 드래그 앤 드롭 이벤트
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const items = e.dataTransfer.items;
            const files = [];
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    traverseFileTree(item, files);
                }
            }
            
            setTimeout(() => {
                if (files.length > 0) {
                    processFiles(files);
                }
            }, 100);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
        });

        // 폴더 트리 탐색
        function traverseFileTree(item, files) {
            if (item.isFile) {
                item.file(file => {
                    if (file.type.startsWith('image/')) {
                        files.push(file);
                    }
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries(entries => {
                    entries.forEach(entry => {
                        traverseFileTree(entry, files);
                    });
                });
            }
        }

        // 파일 처리
        async function processFiles(files) {
            // 초기화
            processedFiles = [];
            totalSize = 0;
            convertedSize = 0;
            fileList.innerHTML = '';
            
            // UI 표시
            settings.style.display = 'block';
            progressContainer.style.display = 'block';
            downloadButton.style.display = 'none';
            stats.style.display = 'none';
            
            const quality = qualitySlider.value / 100;
            const zip = new JSZip();
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileItem = createFileItem(file.name);
                fileList.appendChild(fileItem);
                
                try {
                    updateFileStatus(fileItem, 'processing', '처리중...');
                    totalSize += file.size;
                    
                    const result = await processImage(file, quality);
                    zip.file(result.name, result.blob);
                    
                    convertedSize += result.blob.size;
                    processedFiles.push({
                        original: file.name,
                        converted: result.name,
                        originalSize: file.size,
                        convertedSize: result.blob.size
                    });
                    
                    updateFileStatus(fileItem, 'completed', '완료');
                } catch (error) {
                    updateFileStatus(fileItem, 'error', '오류');
                    console.error(`Error processing ${file.name}:`, error);
                }
                
                updateProgress(i + 1, files.length);
            }
            
            // ZIP 생성
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            
            // 다운로드 버튼 활성화
            downloadButton.style.display = 'block';
            downloadButton.onclick = () => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = 'converted_images.zip';
                link.click();
            };
            
            showStats();
        }

        // 이미지 처리
        function processImage(file, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 크기 계산
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 1920;
                        
                        // 긴 쪽이 1920보다 크면 리사이즈
                        if (width > maxSize || height > maxSize) {
                            const ratio = Math.min(maxSize / width, maxSize / height);
                            width = Math.round(width * ratio);
                            height = Math.round(height * ratio);
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
                            const newName = baseName + '.webp';
                            resolve({ blob, name: newName });
                        }, 'image/webp', quality);
                    };
                    
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // UI 헬퍼 함수들
        function createFileItem(filename) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <span class="filename">${filename}</span>
                <span class="status">대기중</span>
            `;
            return item;
        }

        function updateFileStatus(fileItem, statusClass, statusText) {
            const status = fileItem.querySelector('.status');
            status.className = `status ${statusClass}`;
            status.textContent = statusText;
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
        }

        function showStats() {
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            const convertedSizeMB = (convertedSize / 1024 / 1024).toFixed(2);
            const savedPercent = Math.round((1 - convertedSize / totalSize) * 100);
            
            stats.innerHTML = `
                <strong>변환 완료!</strong><br>
                원본 크기: ${totalSizeMB} MB → 변환 후: ${convertedSizeMB} MB<br>
                <strong>${savedPercent}% 용량 절약</strong>
            `;
            stats.style.display = 'block';
        }
    </script>
</body>
</html>